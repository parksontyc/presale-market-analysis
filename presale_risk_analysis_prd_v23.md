# 預售屋市場風險分析系統
## 產品需求文件 (PRD) v2.3

---

## 📑 文件目錄

### [1. 產品概述](#1-產品概述)
- 1.1 [產品名稱與定位](#11-產品名稱與定位)
- 1.2 [核心價值主張](#12-核心價值主張)
- 1.3 [目標用戶群體](#13-目標用戶群體)
- 1.4 [產品目標與範圍](#14-產品目標與範圍)

### [2. 資料架構與處理邏輯](#2-資料架構與處理邏輯)
- 2.1 [資料來源定義](#21-資料來源定義)
- 2.2 [解約資料解析邏輯](#22-解約資料解析邏輯)
- 2.3 [重複交易處理邏輯](#23-重複交易處理邏輯)
- 2.4 [活躍銷售建案定義](#24-活躍銷售建案定義)

### [3. 層級一：社區級分析模組](#3-層級一社區級分析模組)
- 3.1 [社區級報告格式（32欄位）](#31-社區級報告格式32欄位)
- 3.2 [社區級核心計算邏輯](#32-社區級核心計算邏輯)

### [4. 層級二：行政區級分析模組](#4-層級二行政區級分析模組)
- 4.1 [行政區級報告格式（18欄位）](#41-行政區級報告格式18欄位)
- 4.2 [行政區級計算邏輯](#42-行政區級計算邏輯)

### [5. 層級三：縣市級分析模組](#5-層級三縣市級分析模組)
- 5.1 [縣市級報告格式（19欄位）](#51-縣市級報告格式19欄位)
- 5.2 [縣市級計算邏輯](#52-縣市級計算邏輯)

### [6. 風險評估與預警體系](#6-風險評估與預警體系)
- 6.1 [解約風險評估](#61-解約風險評估)
- 6.2 [去化效率評級](#62-去化效率評級)
- 6.3 [長期滯銷建案識別](#63-長期滯銷建案識別)
- 6.4 [三層級風險聚合](#64-三層級風險聚合)

### [7. 技術實作架構](#7-技術實作架構)
- 7.1 [資料處理流程](#71-資料處理流程)
- 7.2 [異常處理機制](#72-異常處理機制)
- 7.3 [績效與品質要求](#73-績效與品質要求)

### [8. 輸出格式與檔案規格](#8-輸出格式與檔案規格)
- 8.1 [輸出檔案結構](#81-輸出檔案結構)
- 8.2 [檔案格式規格](#82-檔案格式規格)
- 8.3 [範例報告展示](#83-範例報告展示)

### [9. 成功指標與驗收標準](#9-成功指標與驗收標準)
- 9.1 [功能完整性指標](#91-功能完整性指標)
- 9.2 [資料準確性指標](#92-資料準確性指標)
- 9.3 [使用者體驗指標](#93-使用者體驗指標)

### [10. 實作規劃與里程碑](#10-實作規劃與里程碑)
- 10.1 [開發階段規劃](#101-開發階段規劃)
- 10.2 [實作進度追蹤](#102-實作進度追蹤)
- 10.3 [後續發展規劃](#103-後續發展規劃)

---

## 1. 產品概述

### 1.1 產品名稱與定位

**產品名稱**：預售屋市場風險分析系統 (Pre-sale Housing Market Risk Analysis System, PHRAS)

**產品定位**：一個三層級（社區級→行政區級→縣市級）的房地產市場風險預警與分析平台，專注於預售屋市場的去化率分析、解約監控、去化動態追蹤與銷售階段判斷，協助政府機關、金融機構、建商及投資人進行科學化決策與風險管理。

### 1.2 核心價值主張

- **🎯 三層級風險預警**：從個別社區到縣市總體的完整風險監控體系
- **📊 動態去化追蹤**：即時去化速度、加速度與效率分析
- **🚨 智能解約監控**：解約資料深度解析與風險分級預警
- **📈 精準市場預測**：基於去化趨勢的完售時間與風險預測
- **🗺️ 空間化風險視覺**：以行政區為單位的風險熱力圖與地圖化呈現

### 1.3 目標用戶群體

| 用戶類型 | 主要需求 | 核心使用場景 |
|----------|----------|-------------|
| **政府機關** | 市場監管、政策制定、風險預警 | 房市調控政策評估、區域發展規劃、系統性風險監控 |
| **金融機構** | 放貸風險評估、投資決策、區域配置 | 不動產抵押貸款審核、區域投資組合配置、風險控管 |
| **建設公司** | 推案策略、競爭分析、銷售監控 | 土地開發評估、銷售策略調整、去化效率提升 |
| **房仲業者** | 市場行情掌握、客戶諮詢、趨勢分析 | 價格趨勢分析、客戶投資建議、區域市場研究 |
| **研究機構** | 學術研究、市場報告、政策分析 | 房市研究報告、政策影響分析、市場動態研究 |

### 1.4 產品目標與範圍

#### 業務目標
- 建立台灣首個系統性三層級預售屋市場風險分析體系
- 提供110Y3S~114Y3S各年季的完整市場動態分析
- 協助識別高風險區域與長期滯銷建案，降低市場系統性風險
- 支援政策制定與投資決策，提升市場透明度

#### 分析範圍
- **時間範圍**：110Y3S~114Y3S各年季完整分析
- **空間範圍**：全台縣市→行政區→社區三層級覆蓋
- **產品範圍**：預售屋市場（未來可擴展至新成屋、成屋）
- **指標範圍**：去化率、解約率、去化動態、價格趨勢、銷售階段、風險評估

---

## 2. 資料架構與處理邏輯

### 2.1 資料來源定義

#### 主要資料檔案
```
📁 lvr_pre_sale_test.csv (43,007筆)：預售屋成交記錄
   關鍵欄位：備查編號、縣市、行政區、交易日期、交易年季、解約情形、
           交易總價、建物單價、總面積、樓層等

📁 lvr_sale_data_test.csv (8,452筆)：建案基本資訊  
   關鍵欄位：編號、社區名稱、戶數、銷售起始時間、銷售起始年季、
           起造人、坐落街道等
```

#### 資料關聯與特性
```
🔗 主要連結：lvr_pre_sale_test.備查編號 ↔ lvr_sale_data_test.編號
📊 測試資料特性：建案資訊為完整申請清單，成交記錄為部分建案樣本
📈 匹配率說明：測試環境約10-15%，正式環境預期60-80%
⏰ 時間範圍：110Y2S ~ 114Y2S (17個年季)
🌏 地理分布：主要為新北市(28,482筆)、台北市(14,525筆)
```

#### 資料格式特徵
```
💥 解約情形格式：null (正常) / "YYYYMMDD全部解約" (解約)
📅 銷售起始時間：YYYYMMDD數字格式 (如: 1100701)
🏢 樓層格式："樓層/總樓層" (如: "3/24")
📊 價格格式：建物單價(萬/坪)、交易總價(萬元)、總面積(坪)
```

### 2.2 解約資料解析邏輯

#### 解約格式識別與處理
```javascript
function parseCancellationData(cancellationField) {
    if (!cancellationField || cancellationField === null || cancellationField === '') {
        return {
            isNormal: true,
            isCancelled: false,
            cancellationDate: null,
            cancellationYearSeason: null
        };
    }
    
    const cancellationStr = String(cancellationField).trim();
    if (cancellationStr.includes('全部解約')) {
        // 處理可能的多重解約，取第一個
        const firstCancellation = cancellationStr.split(';')[0];
        const dateStr = firstCancellation.replace('全部解約', '').trim();
        
        if (dateStr && dateStr.length === 7) {
            const year = dateStr.substring(0, 3);    // 114
            const month = dateStr.substring(3, 5);   // 05
            const day = dateStr.substring(5, 7);     // 30
            
            const fullYear = parseInt(year) + 1911;  // 轉換為西元年
            const cancellationDate = `${fullYear}/${month}/${day}`;
            const monthNum = parseInt(month);
            const season = Math.ceil(monthNum / 3);
            const yearSeason = `${year}Y${season}S`;
            
            return {
                isNormal: false,
                isCancelled: true,
                cancellationDate: cancellationDate,
                cancellationYearSeason: yearSeason
            };
        }
    }
    
    return { isNormal: false, isCancelled: false, cancellationDate: null, cancellationYearSeason: null };
}
```

#### 解約統計結果
```
📊 正常交易: 99.32% (42,714筆)
📊 已解約: 0.68% (293筆) 
📊 解約時間分布: 主要集中在113Y3S~114Y2S期間
📊 解約模式: 以單次解約為主，少數建案有多次解約記錄
```

### 2.3 重複交易處理邏輯

#### 物件識別標準
```
🏠 唯一物件識別 = 備查編號 + 坐落街道 + 樓層
```

#### 有效交易判斷邏輯
```javascript
function getValidTransaction(transactions) {
    const normalTransactions = transactions.filter(tx => tx.是否正常交易);
    const cancelledTransactions = transactions.filter(tx => tx.是否解約);
    
    if (normalTransactions.length > 0) {
        // 返回最早的正常交易
        return normalTransactions.sort((a, b) => a['交易日期'].localeCompare(b['交易日期']))[0];
    } else if (cancelledTransactions.length > 0) {
        // 所有都解約，標記為無效但保留記錄
        const earliest = cancelledTransactions.sort((a, b) => a['交易日期'].localeCompare(b['交易日期']))[0];
        return { ...earliest, 是否有效交易: false, 無效原因: '全部解約' };
    }
    return null;
}
```

#### 處理結果標記
```
✅ 是否有效交易: true/false
🔢 重複交易數: 該物件的交易總次數
❌ 無效原因: 解約原因說明（如適用）
📅 有效交易日期: 最終採用的交易日期
```

### 2.4 活躍銷售建案定義

#### 基礎定義標準
```
✅ 活躍銷售建案判斷條件：
   (該年季 >= 銷售起始年季) AND (累積去化率 < 100%)
```

#### 長期滯銷建案特別處理
```
🔴 長期滯銷標準：
   - 銷售期間 > 12季 (3年)
   - 連續12季無成交  
   - 累積去化率 < 70%

🏷️ 分類處理：
   1. 正常活躍建案：符合活躍定義但非長期滯銷
   2. 長期滯銷建案：符合滯銷條件的建案
   3. 完售建案：累積去化率 = 100%
   4. 未開售建案：該年季 < 銷售起始年季
```

---

## 3. 層級一：社區級分析模組

### 3.1 社區級報告格式（32欄位）

#### A. 基本資訊 (7欄)
- **備查編號**：建案唯一識別碼
- **社區名稱**：建案名稱
- **縣市**：所在縣市
- **行政區**：所在行政區  
- **坐落街道**：建案地址
- **總戶數**：建案總戶數
- **銷售起始年季**：開始銷售的年季

#### B. 時間與數量 (5欄)
- **年季**：分析目標年季
- **銷售季數**：從銷售起始到目標年季的累積季數
- **累積成交筆數**：從銷售起始累積的成交筆數
- **該季成交筆數**：目標年季的成交筆數
- **該季銷售天數**：目標年季的實際銷售天數

#### C. 解約資訊 (6欄)
- **累積解約筆數**：從銷售起始累積的解約筆數
- **該季解約筆數**：目標年季的解約筆數
- **季度解約率(%)**：該季解約筆數 ÷ 該季成交筆數 × 100%
- **累積解約率(%)**：累積解約筆數 ÷ 累積成交筆數 × 100%
- **最近解約年季**：最近一次解約發生的年季
- **連續無解約季數**：連續未發生解約的季數

#### D. 去化分析 (3欄)
- **毛去化率(%)**：累積成交筆數 ÷ 總戶數 × 100%
- **淨去化率(%)**：(累積成交筆數 - 累積解約筆數) ÷ 總戶數 × 100%
- **調整去化率(%)**：考慮非完整季的標準化去化率

#### E. 去化動態分析 (4欄)
- **季度去化速度(戶/季)**：本季去化戶數變化量
- **去化加速度(%)**：去化速度的變化率
- **預估完售季數**：基於當前去化速度的完售預測
- **去化效率評級**：🚀高效/⭐正常/⚠️緩慢/🐌滯銷

#### F. 價格分析 (3欄)
- **平均交易單價(萬/坪)**：該季成交案例的成交筆數加權平均單價
- **平均總面積(坪)**：該季成交案例的平均面積
- **平均交易總價(萬)**：該季成交案例的平均總價

#### G. 階段分析 (3欄)
- **銷售階段**：開盤初期/穩定銷售期/中後期調整/尾盤清售/完售
- **階段表現**：🟢良好/🟡普通/🔴不佳
- **解約警示**：🟢低風險/🟡中風險/🔴高風險

#### H. 品質控制 (1欄)
- **是否完整季**：Y=完整季度, N=非完整季度

### 3.2 社區級核心計算邏輯

#### 3.2.1 去化率計算
```python
def calculate_absorption_rates(建案資料, 目標年季):
    # 毛去化率
    毛去化率 = 累積成交筆數 / 總戶數 * 100
    
    # 淨去化率  
    淨去化率 = (累積成交筆數 - 累積解約筆數) / 總戶數 * 100
    
    # 調整去化率（非完整季處理）
    if 是否完整季 == 'N':
        該季完整度 = 該季銷售天數 / 該季總天數
        調整去化率 = 毛去化率 / 該季完整度
    else:
        調整去化率 = 毛去化率
    
    return 毛去化率, 淨去化率, 調整去化率
```

#### 3.2.2 去化動態分析計算
```python
def calculate_absorption_dynamics(建案資料, 目標年季, 上季資料=None):
    # 季度去化速度計算
    if 上季資料:
        本季去化戶數 = (建案資料['淨去化率'] - 上季資料['淨去化率']) / 100 * 建案資料['總戶數']
        季度去化速度 = max(0, 本季去化戶數)  # 不允許負值
    else:
        # 首季計算
        季度去化速度 = 建案資料['淨去化率'] / 100 * 建案資料['總戶數'] / 建案資料['銷售季數']
    
    # 去化加速度計算
    if 上季資料 and 上季資料.get('季度去化速度', 0) > 0:
        上季去化速度 = 上季資料['季度去化速度']
        去化加速度 = (季度去化速度 - 上季去化速度) / 上季去化速度 * 100
    else:
        去化加速度 = 0
    
    # 預估完售季數計算
    當前去化率 = 建案資料['淨去化率']
    剩餘去化率 = 100 - 當前去化率
    
    if 季度去化速度 > 0 and 當前去化率 < 100:
        剩餘戶數 = 剩餘去化率 / 100 * 建案資料['總戶數']
        預估完售季數 = math.ceil(剩餘戶數 / 季度去化速度)
    elif 當前去化率 >= 100:
        預估完售季數 = 0  # 已完售
    else:
        預估完售季數 = 999  # 無法預估（去化停滯）
    
    # 去化效率評級
    def evaluate_absorption_efficiency(已銷售季數, 當前去化率, 季度去化速度):
        if 當前去化率 >= 100:
            if 已銷售季數 <= 8:
                return "🚀 高效完售"
            elif 已銷售季數 <= 12:
                return "⭐ 正常完售"
            else:
                return "⚠️ 緩慢完售"
        
        # 未完售建案評級
        if 當前去化率 >= 70 and 季度去化速度 >= 3:
            return "🚀 高效去化"
        elif 當前去化率 >= 50 and 季度去化速度 >= 2:
            return "⭐ 正常去化"
        elif 當前去化率 >= 30 and 季度去化速度 >= 1:
            return "⚠️ 緩慢去化"
        else:
            return "🐌 滯銷狀態"
    
    去化效率評級 = evaluate_absorption_efficiency(建案資料['銷售季數'], 當前去化率, 季度去化速度)
    
    return {
        '季度去化速度': round(季度去化速度, 2),
        '去化加速度': round(去化加速度, 2),
        '預估完售季數': 預估完售季數,
        '去化效率評級': 去化效率評級
    }
```

#### 3.2.3 解約風險評估
```python
def assess_cancellation_risk(累積解約率, 季度解約率, 連續無解約季數):
    風險分數 = 0
    
    # 累積解約率評估（基於市場平均0.68%）
    if 累積解約率 > 5:      # 高於市場平均的7倍
        風險分數 += 3
    elif 累積解約率 > 2:    # 高於市場平均的3倍
        風險分數 += 1
    
    # 季度解約率評估
    if 季度解約率 > 10:     # 單季高解約
        風險分數 += 3
    elif 季度解約率 > 5:    # 單季中等解約
        風險分數 += 1
    
    # 連續解約趨勢
    if 連續無解約季數 == 0:  # 本季有解約
        風險分數 += 1
    elif 連續無解約季數 >= 4: # 連續一年無解約
        風險分數 -= 1        # 降低風險分數
    
    # 風險等級判斷
    if 風險分數 >= 4:
        return "🔴 解約高風險"
    elif 風險分數 >= 2:
        return "🟡 解約中風險"
    else:
        return "🟢 解約低風險"
```

#### 3.2.4 銷售階段判斷
```python
def determine_sales_stage(銷售季數, 累積去化率, 季度去化速度):
    if 累積去化率 >= 100:
        return "完售"
    elif 累積去化率 > 90:
        return "尾盤清售"
    elif 銷售季數 <= 2:
        return "開盤初期"
    elif 銷售季數 <= 6 and 累積去化率 < 80:
        return "穩定銷售期"
    else:
        return "中後期調整"

def determine_stage_performance(銷售階段, 銷售季數, 累積去化率, 季度去化速度):
    stage_criteria = {
        "開盤初期": {
            "🟢良好": 累積去化率 >= 25 and 季度去化速度 >= 2,
            "🟡普通": 10 <= 累積去化率 < 25 or 季度去化速度 >= 1,
            "🔴不佳": 累積去化率 < 10 and 季度去化速度 < 1
        },
        "穩定銷售期": {
            "🟢良好": 累積去化率 > 50 and 季度去化速度 >= 2,
            "🟡普通": 20 <= 累積去化率 <= 50 and 季度去化速度 >= 1,
            "🔴不佳": 累積去化率 < 20 or 季度去化速度 < 1
        }
        # ... 其他階段邏輯
    }
    
    for performance, condition in stage_criteria.get(銷售階段, {}).items():
        if condition:
            return performance
    return "🟡普通"  # 預設值
```

---

## 4. 層級二：行政區級分析模組

### 4.1 行政區級報告格式（18欄位）

```
| 縣市 | 行政區 | 年季 | 活躍建案數 | 正常活躍建案數 | 長期滯銷建案數 |
| 區域總戶數 | 整體淨去化率(%) | 正常建案去化率(%) | 
| 區域總解約筆數 | 區域解約率(%) | 區域解約風險等級 |
| 區域平均去化速度(戶/季) | 區域去化效率排名 | 區域去化趨勢 |
| 加權平均單價(萬/坪) | 長期滯銷影響度(%) | 區域階段 | 風險等級 |
```

#### 新增欄位說明
- **區域總解約筆數**：該行政區所有建案的累積解約筆數總和
- **區域解約率(%)**：區域總解約筆數 ÷ 區域總成交筆數 × 100%
- **區域解約風險等級**：🟢低風險/🟡中風險/🔴高風險
- **區域平均去化速度(戶/季)**：該行政區所有活躍建案的季度去化速度加權平均
- **區域去化效率排名**：在同縣市內行政區中的去化效率排名
- **區域去化趨勢**：🚀加速/📈穩定/📉減緩/⚠️停滯

### 4.2 行政區級計算邏輯

#### 4.2.1 活躍建案統計
```python
def classify_district_projects(社區級資料, 目標年季):
    活躍建案 = 社區級資料[
        (社區級資料['年季'] >= 社區級資料['銷售起始年季']) & 
        (社區級資料['累積去化率'] < 100)
    ]
    
    長期滯銷建案 = 活躍建案[
        (活躍建案['銷售季數'] > 12) & 
        (活躍建案['連續無成交季數'] >= 12) & 
        (活躍建案['累積去化率'] < 70)
    ]
    
    正常活躍建案 = 活躍建案[~活躍建案.index.isin(長期滯銷建案.index)]
    
    return {
        '活躍建案數': len(活躍建案),
        '正常活躍建案數': len(正常活躍建案),
        '長期滯銷建案數': len(長期滯銷建案)
    }
```

#### 4.2.2 區域去化率計算
```python
def calculate_district_absorption_rate(活躍建案資料):
    # 整體淨去化率（總戶數加權）
    總成交數 = 活躍建案資料['累積成交筆數'].sum()
    總解約數 = 活躍建案資料['累積解約筆數'].sum()
    總戶數 = 活躍建案資料['總戶數'].sum()
    
    整體淨去化率 = (總成交數 - 總解約數) / 總戶數 * 100
    
    # 正常建案去化率
    正常建案 = 活躍建案資料[活躍建案資料['是否長期滯銷'] == 'N']
    正常總成交數 = 正常建案['累積成交筆數'].sum()
    正常總解約數 = 正常建案['累積解約筆數'].sum()  
    正常總戶數 = 正常建案['總戶數'].sum()
    
    正常建案去化率 = (正常總成交數 - 正常總解約數) / 正常總戶數 * 100
    
    return 整體淨去化率, 正常建案去化率
```

#### 4.2.3 區域去化動態分析
```python
def calculate_district_absorption_dynamics(社區級資料, 上季行政區資料=None):
    # 區域平均去化速度（戶數加權平均）
    總戶數權重 = 社區級資料['總戶數'].sum()
    加權去化速度總和 = (社區級資料['總戶數'] * 社區級資料['季度去化速度']).sum()
    
    if 總戶數權重 > 0:
        區域平均去化速度 = 加權去化速度總和 / 總戶數權重
    else:
        區域平均去化速度 = 0
    
    # 區域去化趨勢判斷
    def determine_district_absorption_trend(本季平均速度, 上季平均速度=None):
        if 上季平均速度 is None:
            return "📈 初期銷售"
        
        速度變化率 = (本季平均速度 - 上季平均速度) / 上季平均速度 * 100 if 上季平均速度 > 0 else 0
        
        if 速度變化率 > 20:
            return "🚀 加速去化"
        elif 速度變化率 > -10:
            return "📈 穩定去化"
        elif 速度變化率 > -30:
            return "📉 減緩去化"
        else:
            return "⚠️ 去化停滯"
    
    上季平均速度 = 上季行政區資料.get('區域平均去化速度', None) if 上季行政區資料 else None
    區域去化趨勢 = determine_district_absorption_trend(區域平均去化速度, 上季平均速度)
    
    # 區域去化效率分數計算
    區域去化效率分數 = 計算區域去化效率分數(社區級資料)
    
    return {
        '區域平均去化速度': round(區域平均去化速度, 2),
        '區域去化效率分數': 區域去化效率分數,
        '區域去化趨勢': 區域去化趨勢
    }
```

#### 4.2.4 區域解約分析計算
```python
def calculate_district_cancellation_metrics(社區級資料):
    # 區域解約統計
    區域總解約筆數 = 社區級資料['累積解約筆數'].sum()
    區域總成交筆數 = 社區級資料['累積成交筆數'].sum()
    
    # 區域解約率
    if 區域總成交筆數 > 0:
        區域解約率 = 區域總解約筆數 / 區域總成交筆數 * 100
    else:
        區域解約率 = 0
    
    # 建案解約風險分布統計
    高風險建案數 = len(社區級資料[社區級資料['解約警示'] == '🔴 解約高風險'])
    總建案數 = len(社區級資料)
    
    # 區域解約風險等級評估
    def assess_district_cancellation_risk(區域解約率, 高風險建案比例):
        風險分數 = 0
        
        # 區域整體解約率
        if 區域解約率 > 3:      # 高於市場平均的4倍以上
            風險分數 += 3
        elif 區域解約率 > 1.5:   # 高於市場平均的2倍以上
            風險分數 += 1
        
        # 高風險建案比例
        if 高風險建案比例 > 30:   # 超過30%建案為高風險
            風險分數 += 2
        elif 高風險建案比例 > 15:  # 超過15%建案為高風險
            風險分數 += 1
        
        # 風險等級判斷
        if 風險分數 >= 3:
            return "🔴 區域解約高風險"
        elif 風險分數 >= 1:
            return "🟡 區域解約中風險"
        else:
            return "🟢 區域解約低風險"
    
    高風險建案比例 = 高風險建案數 / 總建案數 * 100 if 總建案數 > 0 else 0
    區域解約風險等級 = assess_district_cancellation_risk(區域解約率, 高風險建案比例)
    
    return {
        '區域總解約筆數': 區域總解約筆數,
        '區域解約率': 區域解約率,
        '區域解約風險等級': 區域解約風險等級,
        '高風險建案數': 高風險建案數,
        '高風險建案比例': 高風險建案比例
    }
```

---

## 5. 層級三：縣市級分析模組

### 5.1 縣市級報告格式（19欄位）

```
| 縣市 | 年季 | 活躍行政區數 | 縣市總建案數 | 新推案數量 | 完售建案數量 | 
| 縣市總戶數 | 縣市總成交數 | 縣市加權去化率(%) | 長期滯銷建案占比(%) |
| 縣市總解約筆數 | 縣市解約率(%) | 縣市解約風險等級 |
| 縣市平均去化速度(戶/季) | 縣市去化表現分級 |
| 縣市加權平均單價(萬/坪) | 價格漲跌幅(%) | 主要熱點行政區 | 高風險行政區數 | 縣市風險等級 |
```

#### 新增欄位說明
- **縣市總解約筆數**：全縣市所有建案的累積解約筆數總和
- **縣市解約率(%)**：縣市總解約筆數 ÷ 縣市總成交數 × 100%
- **縣市解約風險等級**：🟢低風險/🟡中風險/🔴高風險
- **縣市平均去化速度(戶/季)**：全縣市所有活躍建案的季度去化速度加權平均
- **縣市去化表現分級**：🏆優秀/🥇良好/🥈普通/🥉不佳

### 5.2 縣市級計算邏輯

#### 5.2.1 基礎統計指標
```python
def calculate_city_basic_stats(行政區資料, 社區資料, 目標年季):
    # 活躍行政區數
    活躍行政區數 = len(行政區資料[行政區資料['活躍建案數'] > 0])
    
    # 縣市總建案數
    縣市總建案數 = 社區資料['活躍建案'].sum()
    
    # 新推案數量（該季開始銷售）
    新推案數量 = len(社區資料[社區資料['銷售起始年季'] == 目標年季])
    
    # 完售建案數量
    完售建案數量 = len(社區資料[社區資料['累積去化率'] >= 100])
    
    return {
        '活躍行政區數': 活躍行政區數,
        '縣市總建案數': 縣市總建案數,
        '新推案數量': 新推案數量,
        '完售建案數量': 完售建案數量
    }
```

#### 5.2.2 縣市去化動態分析
```python
def calculate_city_absorption_dynamics(行政區資料, 社區資料):
    # 縣市平均去化速度（總戶數加權平均）
    縣市總戶數 = 社區資料['總戶數'].sum()
    加權去化速度總和 = (社區資料['總戶數'] * 社區資料['季度去化速度']).sum()
    
    if 縣市總戶數 > 0:
        縣市平均去化速度 = 加權去化速度總和 / 縣市總戶數
    else:
        縣市平均去化速度 = 0
    
    # 縣市去化表現分級
    def determine_city_absorption_performance(平均去化速度, 平均去化率, 完售建案占比):
        綜合分數 = 0
        
        # 去化速度評分 (0-40分)
        if 平均去化速度 >= 3:
            綜合分數 += 40
        elif 平均去化速度 >= 2:
            綜合分數 += 30
        elif 平均去化速度 >= 1:
            綜合分數 += 20
        else:
            綜合分數 += 10
        
        # 去化率評分 (0-30分)
        if 平均去化率 >= 60:
            綜合分數 += 30
        elif 平均去化率 >= 45:
            綜合分數 += 25
        elif 平均去化率 >= 30:
            綜合分數 += 15
        else:
            綜合分數 += 5
        
        # 完售表現評分 (0-30分)
        if 完售建案占比 >= 20:
            綜合分數 += 30
        elif 完售建案占比 >= 10:
            綜合分數 += 20
        elif 完售建案占比 >= 5:
            綜合分數 += 10
        
        # 分級判斷
        if 綜合分數 >= 80:
            return "🏆 優秀表現"
        elif 綜合分數 >= 65:
            return "🥇 良好表現"
        elif 綜合分數 >= 45:
            return "🥈 普通表現"
        else:
            return "🥉 待改善表現"
    
    # 計算所需指標
    縣市加權去化率 = calculate_city_weighted_absorption_rate(行政區資料)
    完售建案數 = len(社區資料[社區資料['淨去化率'] >= 100])
    完售建案占比 = 完售建案數 / len(社區資料) * 100 if len(社區資料) > 0 else 0
    
    縣市去化表現分級 = determine_city_absorption_performance(縣市平均去化速度, 縣市加權去化率, 完售建案占比)
    
    return {
        '縣市平均去化速度': round(縣市平均去化速度, 2),
        '縣市去化表現分級': 縣市去化表現分級
    }
```

#### 5.2.3 縣市解約分析計算
```python
def calculate_city_cancellation_metrics(行政區資料, 社區資料):
    # 縣市解約統計
    縣市總解約筆數 = 社區資料['累積解約筆數'].sum()
    縣市總成交數 = 社區資料['累積成交筆數'].sum()
    
    # 縣市解約率
    if 縣市總成交數 > 0:
        縣市解約率 = 縣市總解約筆數 / 縣市總成交數 * 100
    else:
        縣市解約率 = 0
    
    # 行政區解約風險分布
    高風險行政區數 = len(行政區資料[行政區資料['區域解約風險等級'].str.contains('🔴')])
    總行政區數 = len(行政區資料)
    
    # 縣市解約風險等級評估
    def assess_city_cancellation_risk(縣市解約率, 高風險行政區比例, 長期滯銷占比):
        風險分數 = 0
        
        # 縣市整體解約率
        if 縣市解約率 > 2:        # 高於市場平均的3倍以上
            風險分數 += 3
        elif 縣市解約率 > 1:       # 高於市場平均的1.5倍以上
            風險分數 += 1
        
        # 高風險行政區比例
        if 高風險行政區比例 > 25:   # 超過25%行政區為高風險
            風險分數 += 2
        elif 高風險行政區比例 > 15:  # 超過15%行政區為高風險
            風險分數 += 1
        
        # 長期滯銷影響
        if 長期滯銷占比 > 15:      # 高滯銷率增加解約風險
            風險分數 += 1
        
        # 風險等級判斷
        if 風險分數 >= 4:
            return "🔴 縣市解約高風險"
        elif 風險分數 >= 2:
            return "🟡 縣市解約中風險"
        else:
            return "🟢 縣市解約低風險"
    
    高風險行政區比例 = 高風險行政區數 / 總行政區數 * 100 if 總行政區數 > 0 else 0
    長期滯銷占比 = calculate_city_stagnant_ratio(社區資料)
    縣市解約風險等級 = assess_city_cancellation_risk(縣市解約率, 高風險行政區比例, 長期滯銷占比)
    
    return {
        '縣市總解約筆數': 縣市總解約筆數,
        '縣市解約率': 縣市解約率,
        '縣市解約風險等級': 縣市解約風險等級,
        '高風險行政區數': 高風險行政區數,
        '高風險行政區比例': 高風險行政區比例
    }
```

---

## 6. 風險評估與預警體系

### 6.1 解約風險評估

#### 市場基準參考
```
📊 市場解約率基準（基於實際資料分析）：
   - 整體解約率: 0.68%
   - 正常範圍: 0-2%
   - 警示範圍: 2-5%
   - 高風險範圍: >5%
```

#### 三層級解約風險分級
```
🏢 社區級解約風險：
   🟢 低風險: 累積解約率 < 2% 且 季度解約率 < 5%
   🟡 中風險: 累積解約率 2-5% 或 季度解約率 5-10%
   🔴 高風險: 累積解約率 > 5% 或 季度解約率 > 10%

🏘️ 行政區級解約風險：
   🟢 低風險: 區域解約率 < 1.5% 且 高風險建案比例 < 15%
   🟡 中風險: 區域解約率 1.5-3% 或 高風險建案比例 15-30%
   🔴 高風險: 區域解約率 > 3% 或 高風險建案比例 > 30%

🏙️ 縣市級解約風險：
   🟢 低風險: 縣市解約率 < 1% 且 高風險行政區比例 < 15%
   🟡 中風險: 縣市解約率 1-2% 或 高風險行政區比例 15-25%
   🔴 高風險: 縣市解約率 > 2% 或 高風險行政區比例 > 25%
```

### 6.2 去化效率評級

#### 去化動態基準值
```
📈 去化動態基準（用於區域比較）：
   - 高效去化速度: ≥3.0戶/季
   - 正常去化速度: 2.0戶/季  
   - 緩慢去化速度: 1.0戶/季
   - 理想完售季數: ≤8季
   - 正常完售季數: ≤12季
   - 長期銷售季數: >16季
```

#### 四級去化效率評級
```
🚀 高效去化: 去化率≥70% + 季度去化速度≥3戶/季
⭐ 正常去化: 去化率≥50% + 季度去化速度≥2戶/季  
⚠️ 緩慢去化: 去化率≥30% + 季度去化速度≥1戶/季
🐌 滯銷狀態: 其他情況
```

### 6.3 長期滯銷建案識別

#### 滯銷判斷標準
```
🔴 長期滯銷建案標準：
   - 銷售期間 > 12季 (3年)
   - 連續12季無成交
   - 累積去化率 < 70%

📊 滯銷影響度計算：
   - 社區級: 個別建案滯銷狀態標記
   - 行政區級: 滯銷建案數 ÷ 活躍建案數 × 100%
   - 縣市級: 滯銷建案數 ÷ 縣市總建案數 × 100%

⚠️ 滯銷影響度分級：
   🟢 < 10%: 影響輕微
   🟡 10-25%: 需要關注
   🔴 > 25%: 嚴重影響
```

### 6.4 三層級風險聚合

#### 綜合風險評估邏輯
```python
def assess_comprehensive_risk(去化率, 解約風險, 滯銷影響度, 去化速度):
    風險分數 = 0
    
    # 去化率風險 (0-4分)
    if 去化率 < 25:
        風險分數 += 4
    elif 去化率 < 40:
        風險分數 += 2
    elif 去化率 < 60:
        風險分數 += 1
    
    # 解約風險 (0-3分)
    if '🔴' in 解約風險:
        風險分數 += 3
    elif '🟡' in 解約風險:
        風險分數 += 1
    
    # 滯銷影響 (0-2分)
    if 滯銷影響度 > 25:
        風險分數 += 2
    elif 滯銷影響度 > 10:
        風險分數 += 1
    
    # 去化速度風險 (0-2分)
    if 去化速度 < 1:
        風險分數 += 2
    elif 去化速度 < 2:
        風險分數 += 1
    
    # 總風險等級判斷
    if 風險分數 >= 7:
        return "🔴 高風險"
    elif 風險分數 >= 4:
        return "🟡 中風險"
    else:
        return "🟢 低風險"
```

---

## 7. 技術實作架構

### 7.1 資料處理流程

#### 完整7步驟處理流程
```
Step 1: 資料載入與驗證
├── CSV檔案讀取與編碼處理（UTF-8）
├── 欄位格式標準化與型別轉換
├── 缺失值與異常值檢查
└── 資料關聯性驗證

Step 2: 解約資料解析與標準化
├── 解約狀態解析（"YYYYMMDD全部解約" → 結構化資料）
├── 解約日期轉換（民國年 → 西元年 → 年季）
├── 解約時間序列建立
└── 解約風險分級標記

Step 3: 重複交易識別與去重處理  
├── 物件唯一ID建立（備查編號+街道+樓層）
├── 重複交易分組與排序
├── 有效交易判斷（優先正常交易，最早日期）
└── 無效交易標記與原因記錄

Step 4: 建案資訊匹配與整合
├── 建案編號匹配處理
├── 缺失建案資訊的推估邏輯
├── 地理資訊一致性檢查
└── 整合資料品質驗證

Step 5: 核心指標計算
├── 有效交易統計與分類
├── 活躍建案識別與狀態判斷
├── 去化率計算（毛/淨/調整）
├── 去化動態分析（速度/加速度/預測）
└── 解約率計算與趨勢分析

Step 6: 銷售階段與風險評估
├── 銷售階段判斷邏輯
├── 長期滯銷建案標記
├── 解約風險評估與分級
├── 去化效率評級
└── 價格趨勢分析

Step 7: 三層級報告生成
├── 社區級詳細分析（32欄位）
├── 行政區級彙總分析（18欄位）
├── 縣市級總體分析（19欄位）
└── 結果驗證與品質控制

🎯 實作狀態：
✅ Step 1-2: 已完成（解約資料解析功能）
🔄 Step 3-4: 開發中（重複交易處理與匹配邏輯）
⏳ Step 5-7: 待開發
```

### 7.2 異常處理機制

#### 資料品質檢查標準
```python
# 異常值過濾標準
def filter_outliers(df):
    # 價格異常過濾
    price_filter = (df['建物單價'] >= 100000) & (df['建物單價'] <= 3000000)
    
    # 面積異常過濾  
    area_filter = (df['總面積_數值'] >= 5) & (df['總面積_數值'] <= 200)
    
    # 總價異常過濾
    total_price_filter = (df['交易總價'] >= 5000000) & (df['交易總價'] <= 500000000)
    
    return df[price_filter & area_filter & total_price_filter]

# 邏輯一致性檢查
def validate_logical_consistency(df):
    issues = {}
    
    # 累積成交數不能超過總戶數
    invalid_cases = df[df['累積成交筆數'] > df['總戶數']]
    if len(invalid_cases) > 0:
        issues['成交數超過總戶數'] = len(invalid_cases)
    
    # 解約數不能超過成交數
    invalid_cancellation = df[df['累積解約筆數'] > df['累積成交筆數']]
    if len(invalid_cancellation) > 0:
        issues['解約數超過成交數'] = len(invalid_cancellation)
    
    # 去化率不能超過100%
    invalid_absorption = df[df['淨去化率'] > 100]
    if len(invalid_absorption) > 0:
        issues['去化率超過100%'] = len(invalid_absorption)
    
    return issues
```

#### 缺失值處理策略
```python
MISSING_VALUE_STRATEGY = {
    '解約情形': '填入"正常"',
    '車位總價': '填入0或排除計算',
    '銷售起始時間': '使用最早交易日期估算',
    '社區名稱': '從交易記錄推估',
    '總戶數': '標記為需要人工確認'
}
```

### 7.3 績效與品質要求

#### 系統效能要求
```
⚡ 處理效能要求：
   - 單次分析50,000筆資料 < 60秒
   - 三層級報告生成 < 120秒
   - 系統響應時間 < 5秒
   - 支援並行處理多個年季

📊 資料品質標準：
   - 關鍵欄位缺失率 < 5%
   - 異常值過濾率 < 10%
   - 計算邏輯一致性 > 95%
   - 地理資訊準確率 > 98%

🎯 輸出品質控制：
   - 所有去化率 ≤ 100%
   - 所有解約率 ≤ 100%  
   - 地理階層一致性檢查
   - 時間序列邏輯檢查
   - 跨層級資料一致性驗證
```

---

## 8. 輸出格式與檔案規格

### 8.1 輸出檔案結構

#### 主要輸出檔案
```
📊 主要分析報告：
1. community_level_analysis_YYYYMMDD.csv (社區級分析 - 32欄位)
2. district_level_analysis_YYYYMMDD.csv (行政區級分析 - 18欄位)  
3. city_level_analysis_YYYYMMDD.csv (縣市級分析 - 19欄位)

📋 輔助分析檔案：
4. data_quality_report_YYYYMMDD.csv (資料品質報告)
5. calculation_summary_YYYYMMDD.txt (計算過程摘要)
6. error_log_YYYYMMDD.txt (錯誤處理記錄)

🚨 解約專項分析檔案：
7. cancellation_analysis_YYYYMMDD.csv (解約分析專報)
8. cancellation_summary_by_district_YYYYMMDD.csv (行政區解約統計)
9. cancellation_summary_by_city_YYYYMMDD.csv (縣市解約統計)
10. cancellation_trend_analysis_YYYYMMDD.csv (解約趨勢分析)

🚀 去化動態專項分析檔案：
11. absorption_speed_analysis_YYYYMMDD.csv (去化速度分析)
12. absorption_efficiency_ranking_YYYYMMDD.csv (去化效率排名)
13. absorption_forecast_YYYYMMDD.csv (去化預測分析)
```

### 8.2 檔案格式規格

#### 技術規格
```
📝 檔案格式規格：
   - 編碼格式：UTF-8 with BOM
   - 分隔符號：逗號 (,)
   - 引號處理：雙引號包圍含逗號的文字欄位
   - 日期格式：YYYY/MM/DD
   - 數值格式：小數點後2位 (百分比不含%符號)

📊 預估資料量：
   - 社區級報告：約8,000-15,000筆記錄, 32欄位 (視時間範圍)
   - 行政區級報告：約1,500-3,000筆記錄, 18欄位
   - 縣市級報告：約100-150筆記錄, 19欄位
   - 解約專項分析：約2,000-5,000筆記錄 (各類解約統計)
   - 去化動態專項分析：約3,000-8,000筆記錄 (速度、效率、預測分析)
   - 總檔案大小：約80-150MB (含解約與去化動態分析)
```

### 8.3 範例報告展示

#### 社區級報告範例
```csv
備查編號,社區名稱,縣市,行政區,坐落街道,總戶數,銷售起始年季,年季,銷售季數,累積成交筆數,該季成交筆數,該季銷售天數,累積解約筆數,該季解約筆數,季度解約率,累積解約率,最近解約年季,連續無解約季數,毛去化率,淨去化率,調整去化率,季度去化速度,去化加速度,預估完售季數,去化效率評級,平均交易單價,平均總面積,平均交易總價,銷售階段,階段表現,解約警示,是否完整季
A1234567,信義之星,台北市,信義區,信義路五段188號,100,111Y1S,111Y3S,3,58,23,92,2,1,4.3,3.4,111Y2S,1,58.0,56.0,56.8,7.8,15.2,6,🚀 高效去化,70.8,34.1,2414,穩定銷售期,🟢良好,🟢 解約低風險,Y
```

#### 行政區級報告範例
```csv
縣市,行政區,年季,活躍建案數,正常活躍建案數,長期滯銷建案數,區域總戶數,整體淨去化率,正常建案去化率,區域總解約筆數,區域解約率,區域解約風險等級,區域平均去化速度,區域去化效率排名,區域去化趨勢,加權平均單價,長期滯銷影響度,區域階段,風險等級
台北市,信義區,113Y2S,8,7,1,1200,52.3,54.8,5,0.8,🟢 區域解約低風險,2.8,第1名,🚀 加速去化,68.5,12.5,穩定銷售期,🟢 區域低風險
```

#### 縣市級報告範例
```csv
縣市,年季,活躍行政區數,縣市總建案數,新推案數量,完售建案數量,縣市總戶數,縣市總成交數,縣市加權去化率,長期滯銷建案占比,縣市總解約筆數,縣市解約率,縣市解約風險等級,縣市平均去化速度,縣市去化表現分級,縣市加權平均單價,價格漲跌幅,主要熱點行政區,高風險行政區數,縣市風險等級
台北市,113Y2S,12,45,3,5,4580,2106,46.0,4.4,12,0.57,🟢 縣市解約低風險,2.4,🥇 良好表現,72.3,+2.1,信義區,大安區,松山區,1,🟡 縣市中風險
```

---

## 9. 成功指標與驗收標準

### 9.1 功能完整性指標

#### 已完成功能驗證
```
✅ 解約資料解析功能：100%完成
   - 解約資料格式解析準確率：100%
   - 解約時間轉換正確性：已驗證
   - 解約統計與分布分析：已完成
   - 物件唯一ID建立邏輯：已確認

✅ 三層級解約分析設計：100%完成
✅ 三層級去化動態分析設計：100%完成
✅ 資料格式標準化：100%完成
```

#### 待完成功能目標
```
⏳ 重複交易處理實作：設計完成，待開發
⏳ 三層級報告完整生成：待開發
⏳ 32個社區級欄位準確計算：待開發
⏳ 長期滯銷建案正確識別：待開發
⏳ 解約風險分級準確性：待開發
⏳ 去化動態計算與預測：待開發
```

### 9.2 資料準確性指標

#### 目標準確性標準
```
🎯 資料處理準確性：
   - 去化率計算邏輯驗證通過率 > 98%
   - 重複交易處理準確率 > 95%
   - 解約記錄處理正確率 > 98%
   - 三層級資料一致性 > 99%

🎯 風險評估準確性：
   - 解約風險分級準確性 > 90%
   - 去化效率評級準確性 > 90%
   - 銷售階段判斷準確性 > 85%
   - 長期滯銷識別準確性 > 95%
```

### 9.3 使用者體驗指標

#### 輸出品質目標
```
📋 報告品質標準：
   - 報告格式清晰易讀：所有欄位都有明確說明
   - 風險標示直觀明確：色彩編碼與emoji標記
   - 計算邏輯文件完整：所有公式都有詳細說明
   - 異常處理機制健全：錯誤訊息明確可追蹤

🚀 使用者體驗目標：
   - 報告生成速度 < 2分鐘
   - 檔案開啟速度 < 10秒
   - 資料更新頻率：支援季度更新
   - 多格式支援：CSV主要，支援Excel匯出
```

---

## 10. 實作規劃與里程碑

### 10.1 開發階段規劃

#### Phase 1: 核心計算引擎開發 (4週)
```
Week 1-2: 重複交易處理實作
✅ 物件去重邏輯實作
✅ 有效交易判斷函數
✅ 重複交易測試與驗證

Week 3-4: 去化率與去化動態計算
✅ 毛/淨/調整去化率計算
✅ 季度去化速度與加速度
✅ 預估完售時間算法
✅ 去化效率評級邏輯
```

#### Phase 2: 三層級聚合分析 (3週)
```
Week 5-6: 行政區級聚合邏輯
✅ 區域解約風險聚合
✅ 區域去化動態聚合
✅ 區域效率排名計算

Week 7: 縣市級總體分析
✅ 縣市解約風險聚合
✅ 縣市去化表現分級
✅ 跨縣市比較邏輯
```

#### Phase 3: 報告生成與優化 (2週)
```
Week 8: 報告生成系統
✅ 三層級CSV檔案產生
✅ 專項分析檔案產生
✅ 資料品質報告生成

Week 9: 系統測試與優化
✅ 效能測試與優化
✅ 異常處理測試
✅ 邊界條件測試
✅ 用戶驗收測試
```

### 10.2 實作進度追蹤

#### 當前實作狀態 (v2.3)
```
✅ 已完成項目：
   - 解約資料解析功能：100%
   - 三層級解約分析設計：100%
   - 三層級去化動態分析設計：100%
   - 資料格式標準化：100%
   - PRD文件完整規格：100%

🔄 進行中項目：
   - 重複交易處理邏輯：設計完成，開發中

⏳ 待開發項目：
   - 去化率與去化動態計算模組
   - 三層級聚合分析邏輯
   - 完整報告生成系統
   - 系統測試與品質保證
```

#### 里程碑檢查點
```
🎯 Milestone 1 (Week 2): 重複交易處理完成
🎯 Milestone 2 (Week 4): 社區級分析完整功能
🎯 Milestone 3 (Week 6): 行政區級分析完成
🎯 Milestone 4 (Week 8): 三層級報告系統完成
🎯 Milestone 5 (Week 9): 系統上線準備完成
```

### 10.3 後續發展規劃

#### 短期發展 (6-12個月)
```
🔮 功能擴展：
   - 機器學習預測模型整合
   - 即時監控預警系統
   - 視覺化分析Dashboard
   - API服務開發

📱 平台擴展：
   - Web介面開發
   - 移動應用程式
   - 自動化報告排程
   - 第三方系統整合
```

#### 中期發展 (1-2年)
```
🏗️ 市場擴展：
   - 新成屋市場分析
   - 成屋市場分析
   - 租賃市場分析
   - 商用不動產分析

🔬 技術升級：
   - 大數據分析平台
   - AI驅動的風險預測
   - 地理資訊系統整合
   - 即時數據流處理
```

#### 長期願景 (2-5年)
```
🌐 生態建構：
   - 全方位房地產分析平台
   - 政策影響模擬系統
   - 市場預測與建議系統
   - 開放資料生態建設

🚀 技術創新：
   - 區塊鏈數據驗證
   - 物聯網數據整合
   - 擴增實境市場展示
   - 國際市場擴展框架
```

---

## 📝 附錄與參考

### 附錄A：資料字典
- 完整的欄位定義與格式說明
- 計算公式詳細說明
- 風險等級判斷標準

### 附錄B：API文檔
- RESTful API介面規格
- 資料查詢與匯出API
- 即時監控API設計

### 附錄C：測試計劃
- 單元測試規劃
- 整合測試計劃
- 效能測試標準
- 用戶驗收測試

### 附錄D：部署指南
- 系統環境需求
- 部署步驟說明
- 維運監控指南
- 故障排除手冊

---

**文件版本**：v2.3  
**最後更新**：2025年7月26日  
**負責人**：產品開發團隊  
**文件狀態**：✅ 完整規格，準備實作

**核心功能完整性**：
- ✅ 解約分析體系：100%完成
- ✅ 去化動態分析：100%完成  
- ✅ 三層級風險評估：100%完成
- ✅ 技術實作架構：100%完成
- 🔄 開發實作階段：準備啟動

**下一步執行計劃**：
1. 啟動Phase 1開發：重複交易處理與核心計算引擎
2. 建立開發環境與CI/CD流程
3. 開始單元測試與功能驗證
4. 準備第一個功能原型展示